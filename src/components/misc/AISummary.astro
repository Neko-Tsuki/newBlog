---
import type { CollectionEntry } from "astro:content";
import { aiSummaryConfig } from "@/config";
import { generateAISummary } from "@/utils/ai-summary-utils";

interface Props {
  entry: CollectionEntry<"posts">;
}

const { entry } = Astro.props;
const postContent = entry.body;

// 定义组件状态
let summary = "";
let loading = false;
let error = "";

// 生成AI摘要的函数
async function handleGenerateSummary() {
  // 如果功能未启用，直接返回
  if (!aiSummaryConfig.enable) return;
  
  // 重置状态
  loading = true;
  error = "";
  summary = "";
  
  try {
    summary = await generateAISummary(postContent);
    // 如果调试模式开启，输出调试信息
    if (aiSummaryConfig.debug) {
      console.log("AI摘要生成成功:", summary);
    }
  } catch (err: any) {
    console.error("AI摘要生成失败:", err);
    error = err.message || aiSummaryConfig.display.errorText;
    // 如果调试模式开启，输出调试信息
    if (aiSummaryConfig.debug) {
      console.log("AI摘要生成失败详情:", err);
    }
  } finally {
    loading = false;
  }
}

// 组件挂载时生成摘要
if (aiSummaryConfig.enable) {
  await handleGenerateSummary();
}
---

{aiSummaryConfig.enable && (
  <div class="ai-summary-container mt-6 p-4 rounded-lg card-base transition-all duration-300" id="ai-summary-container">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold flex items-center" style="color: var(--btn-content);">
        <i class="ri-robot-2-line mr-2"></i>
        AI 摘要
      </h3>
      <div class="flex space-x-2">
        <!-- 删除复制按钮和刷新按钮 -->
      </div>
    </div>
    
    <div class="ai-summary-content" id="ai-summary-content">
      {
        loading ? (
          <div class="flex items-center text-gray-500 dark:text-gray-400">
            <i class="ri-loader-4-line animate-spin mr-2"></i>
            {aiSummaryConfig.display.loadingText}
          </div>
        ) : error ? (
          <div class="text-red-500 dark:text-red-400">
            <i class="ri-error-warning-line mr-2"></i>
            {error}
            <button 
              class="ml-4 p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors retry-btn"
              title="重试"
              onclick="window.handleGenerateSummary()"
            >
              <i class="material-symbols:refresh"></i> 重试
            </button>
          </div>
        ) : (
          <div class="prose dark:prose-invert max-w-none">
            <div class="ai-explanation" data-summary={summary}></div>
          </div>
        )
      }
    </div>
  </div>
)}

<script>
  // 声明全局函数以避免类型错误
  if (typeof window !== 'undefined') {
    (window as any).handleGenerateSummary = function() {
      const script = document.createElement('script');
      script.textContent = `
        async function handleGenerateSummary() {
          if (!window.aiSummaryConfig.enable) return;
          window.loading = true;
          window.error = "";
          window.summary = "";
          
          // 修改提示信息为正在重新生成AI摘要...
          const container = document.getElementById("ai-summary-container");
          if (container) {
            const contentElement = container.querySelector("#ai-summary-content");
            if (contentElement) {
              contentElement.innerHTML = \`
                <div class="flex items-center text-gray-500 dark:text-gray-400">
                  <i class="ri-loader-4-line animate-spin mr-2"></i>
                  正在重新生成AI摘要...
                </div>
              \`;
            }
          }
          
          try {
            window.summary = await window.generateAISummary(window.postContent);
            // 如果调试模式开启，输出调试信息
            if (window.aiSummaryConfig.debug) {
              console.log("AI摘要重新生成成功:", window.summary);
            }
          } catch (err) {
            console.error("AI摘要生成失败:", err);
            window.error = err.message || window.aiSummaryConfig.display.errorText;
            // 如果调试模式开启，输出调试信息
            if (window.aiSummaryConfig.debug) {
              console.log("AI摘要重新生成失败详情:", err);
            }
          } finally {
            window.loading = false;
            window.dispatchEvent(new CustomEvent('refresh-ai-summary'));
          }
        }
        handleGenerateSummary();
      `;
      document.body.appendChild(script);
    };
  }

  // 打字机效果
  function typeTextMachineStyle(text: string, targetSelector: string, options: {
    delay?: number;
    startDelay?: number;
    onComplete?: (element: HTMLElement) => void;
    clearBefore?: boolean;
    eraseBefore?: boolean; // 新增：是否以打字机方式清除原文本
    eraseDelay?: number;    // 新增：删除每个字符的间隔
  } = {}) {
    const {
      delay = 50,
      startDelay = 2000,
      onComplete = null,
      clearBefore = true,
      eraseBefore = true, // 新增：是否以打字机方式清除原文本
      eraseDelay = 30,    // 新增：删除每个字符的间隔
    } = options;

    const el = document.querySelector(targetSelector);
    if (!el || typeof text !== "string") return;

    setTimeout(() => {
      const startTyping = () => {
        let index = 0;
        function renderChar() {
          if (index <= text.length) {
            if (el) el.textContent = text.slice(0, index++);
            setTimeout(renderChar, delay);
          } else {
            onComplete && onComplete(el as HTMLElement);
          }
        }
        renderChar();
      };

      if (clearBefore) {
        if (eraseBefore && el.textContent && el.textContent.length > 0) {
          let currentText = el.textContent;
          let eraseIndex = currentText.length;

          function eraseChar() {
            if (eraseIndex > 0) {
              if (el) el.textContent = currentText.slice(0, --eraseIndex);
              setTimeout(eraseChar, eraseDelay);
            } else {
              startTyping(); // 删除完毕后开始打字
            }
          }

          eraseChar();
        } else {
          if (el) el.textContent = "";
          startTyping();
        }
      } else {
        startTyping();
      }
    }, startDelay);
  }

  function renderAISummary() {
    const summaryEl = document.querySelector('.ai-summary-container .ai-explanation');
    if (!summaryEl) return;

    const summaryText = summaryEl.getAttribute('data-summary');
    if (summaryText) {
      // 清除之前的文本
      summaryEl.textContent = '';
      // 应用打字机效果
      typeTextMachineStyle(summaryText, ".ai-summary-container .ai-explanation", {
        delay: 30, // 每个字符的延迟
        startDelay: 500, // 开始延迟
        clearBefore: true,
        eraseBefore: true,
        eraseDelay: 20
      });
    }
  }

  // 页面加载完成后渲染AI摘要
  document.addEventListener("DOMContentLoaded", function() {
    renderAISummary();
    
    // 为重试按钮添加事件监听器
    const container = document.getElementById("ai-summary-container");
    const contentElement = document.getElementById("ai-summary-content");
    
    if (container && contentElement) {
      container.addEventListener("click", async function(e) {
        const target = e.target as HTMLElement;
        if (target.closest(".retry-btn")) {
          // 直接调用 handleGenerateSummary 函数
          if (typeof window !== 'undefined' && (window as any).handleGenerateSummary) {
            (window as any).handleGenerateSummary();
          }
        }
      });
    }
  });
  
  // 重新生成摘要后重新渲染
  window.addEventListener("refresh-ai-summary", function() {
    setTimeout(renderAISummary, 100);
  });
</script>